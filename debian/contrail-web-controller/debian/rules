#!/usr/bin/make -f

SB_TOP := $(shell pwd | sed -re "s/(.*)\/build\/packages(.*)/\1/")
INSTALL_ROOT := $(shell pwd)
export REPO=${SB_TOP}/contrail-web-controller,webController

ifeq (,$(findstring trusty,$(VER)))
        DH_WITH="--with systemd"
else
        DH_WITH=""
endif

%:
	dh $@ $(DH_WITH)

override_dh_installinit:
	dh_installinit
	dh_installinit --name=contrail-webui-jobserver
	dh_installinit --name=contrail-webui-webserver

override_dh_auto_build:
	# We can't use make package directly because it tries to fetch third party
	# from network which is not available during build
	(cd ${SB_TOP}/contrail-web-core; \
	rm -f webroot/html/dashboard.html; \
	rm -f webroot/html/login.html; \
	rm -f webroot/html/login-error.html; \
	cp -a webroot/html/dashboard.tmpl webroot/html/dashboard.html; \
	cp -a webroot/html/login.tmpl webroot/html/login.html; \
	cp -a webroot/html/login-error.tmpl webroot/html/login-error.html; \
	./generate-files.sh 'prod-env' $(REPO));
	(cd ${SB_TOP}/contrail-web-core; \
	./dev-install.sh;)
	(cd ${SB_TOP}/contrail-web-core; \
	./build-files.sh "prod-env" $(REPO);)
	(cd ${SB_TOP}/contrail-web-core; \
	./prod-dev.sh webroot/html/dashboard.html prod_env dev_env true;)
	(cd ${SB_TOP}/contrail-web-core; \
	./prod-dev.sh webroot/html/login.html prod_env dev_env true;)
	(cd ${SB_TOP}/contrail-web-core; \
	./prod-dev.sh webroot/html/login-error.html prod_env dev_env true;)


override_dh_install:
	cp -r -a contrail-web-controller/webroot ${INSTALL_ROOT}
	dh_install
